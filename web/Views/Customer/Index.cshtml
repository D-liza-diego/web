@model web.Models.Customer
@{
    ViewData["Title"] = "Clientes";
      Layout = "~/Views/Shared/_principal.cshtml";

}

<br />
<button type="button" class="btn btn-outline-secondary" data-bs-toggle="modal" data-bs-target="#add">Registrar nuevo</button>
<br />
<br />

@if (Enumerable.Count(ViewBag.customers) > 0)
{
    <table class="table table-striped" id="tabla-customer"  style="text-align: center;">
    <thead class="table-dark">
        <tr>
            <th>Documento</th>
            <th>Nombre</th>
            <th>Opciones</th>
        </tr>
    </thead>
    <tbody >
       @foreach(var item in  ViewBag.customers)
        {
            <tr>
                <td>@item.Dnicustomer</td>
                <td>@item.Namecustomer</td>
                <td>
                    <button idcustomer=@item.Idcustomer id="borrar-customer" type="button" class="btn btn-danger">Eliminar </button>
                    <button idcustomer=@item.Idcustomer id="edit-customer" type="button" class="btn btn-warning" data-bs-toggle="modal" data-bs-target="#editar"  onclick="mostrarID(@item.Idcustomer)"> Editar </button>
                </td>
            </tr>
        }

    </tbody>
</table>  

}
else
{
    <div>
        <h2> Aun no hay datos para mostrar
             <i class="bi bi-search" style="font-size: 4rem;"></i>
        </h2>
    </div>
}
 
<div class="modal fade" id="add" role="dialog">
    <div class="modal-dialog modal-m modal-dialog-centered">
        <div class="modal-content">
            
            <form  method="post" asp-action="SaveCustomer">
                <div class="modal-header">

                      <input  type="number" class="form-control" maxlength="8" placeholder="Ingresar dni" id="buscar-dni"/>
                      <button type="button" class="btn btn-primary" id="buscar-cliente">Buscar</button>
                      
                    
                </div>

                <div class="modal-body">
                        <div asp-validation-summary="ModelOnly" class="text-danger"></div>

                         <div class="form-group">
                            <label asp-for="Dnicustomer" class="control-label"></label>
                            <input asp-for="Dnicustomer" class="form-control" id="add-dni" readonly/>
                            <span asp-validation-for="Dnicustomer" class="text-danger"></span>
                        </div>

                        <div class="form-group">
                            <label asp-for="Namecustomer" class="control-label"></label>
                            <input asp-for="Namecustomer" class="form-control" id="add-nombre" readonly/>
                            <span asp-validation-for="Namecustomer" class="text-danger"></span>
                        </div>

                        <div class="form-group">
                            <label asp-for="Lastnamecustomer" class="control-label"></label>
                            <input  asp-for="Lastnamecustomer" class="form-control" id="add-apellidos" readonly/>
                            <span asp-validation-for="Lastnamecustomer" class="text-danger"></span>
                        </div>

                         <div class="form-group">
                            <label asp-for="Phonecustomer" class="control-label"></label>
                            <input type="number"  asp-for="Phonecustomer"  id="add-telf"  class="form-control"/>
                            <span id="span" asp-validation-for="Phonecustomer" class="text-danger"></span>
                        </div>
           
                </div>
                
                <div class="modal-footer">
                    <button type="button" class="btn btn-danger" data-bs-dismiss="modal" id="cancelar">Cancelar</button>
                     <button type="submit" class="btn btn-primary" id="agregar" disabled >Agregar</button>
                </div>
            </form>
        </div>
    </div>
</div>

<div class="modal fade" id="editar" role="dialog">
    <div class="modal-dialog modal-m modal-dialog-centered">
        <div class="modal-content">
              <div class="modal-header">

                      <input  type="number" class="form-control" maxlength="8" placeholder="Ingresar dni" id="update-buscar-dni" />
                      <button type="button" class="btn btn-primary" id="update-buscar" >Actualizar</button>
                      
                </div>
            
            <form id="update-form" method="post" >
                <input type="hidden" id="id-customer" asp-for="Idcustomer"/>
              
                <div class="modal-body">
                        <div asp-validation-summary="ModelOnly" class="text-danger"></div>

                         <div class="form-group">
                            <label asp-for="Dnicustomer" class="control-label"></label>
                            <input asp-for="Dnicustomer" class="form-control" id="u-dni" readonly/>
                            <span asp-validation-for="Dnicustomer" class="text-danger"></span>
                        </div>

                        <div class="form-group">
                            <label asp-for="Namecustomer" class="control-label"></label>
                            <input asp-for="Namecustomer" class="form-control" id="u-nombre" readonly/>
                            <span asp-validation-for="Namecustomer" class="text-danger"></span>
                        </div>

                        <div class="form-group">
                            <label asp-for="Lastnamecustomer" class="control-label"></label>
                            <input  asp-for="Lastnamecustomer" class="form-control" id="u-apellidos" readonly/>
                            <span asp-validation-for="Lastnamecustomer" class="text-danger"></span>
                        </div>

                         <div class="form-group">
                            <label asp-for="Phonecustomer" class="control-label"></label>
                            <input type="number"  asp-for="Phonecustomer" id="u-telf" class="form-control"/>
                            <span  asp-validation-for="Phonecustomer" class="text-danger"></span>
                        </div>
           
                </div>
                
                <div class="modal-footer">
                    <button type="button" class="btn btn-danger" data-bs-dismiss="modal">Cancelar</button>
                     <button type="button" class="btn btn-primary" id="update-customer" disabled  >Actualizar</button>
                </div>
            </form>
        </div>
    </div>
</div>

<script src="~/lib/jquery/dist/jquery.min.js"></script>
<script src="//cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script>
     var flag=0  
     const boton = document.getElementById("agregar");
     const botonupdate=document.getElementById("update-customer");

 function limpiar()
{
        $('#add-buscar-dni').val('');
        $('#add-dni').val('');
        $('#add-nombre').val('');
        $('#add-apellidos').val('');
        $('#add-telf').val('');

        $('#update-buscar-dni').val('');
        $('#update-dni').val('');
        $('#update-nombre').val('');
        $('#update-apellidos').val('');
        $('#update-telf').val('');
        $('#span').html('');
        boton.setAttribute('disabled',true);
}
function mostrarID(id)
{
        $('#id-customer').val(id)
        console.log( $('#id-customer').val())
}
function addbuscar(id,flag)
{
         $.ajax({
         type:"Get",
         url:'https://dniruc.apisperu.com/api/v1/dni/'+id+'?token=eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9.eyJlbWFpbCI6ImRpZWdvMDNsaXphQGdtYWlsLmNvbSJ9.YMccp65gLQTDdT-ZQNg4uLBmX66IkI_854e6uC2Lglg',
         success:function(result)
         {
             if(result.success==false)
             {
                 Swal.fire({
                icon: 'error',
                title: 'Persona no encontrada',
                showConfirmButton: false,
                timer: 900
                        })
                $('#buscar-dni').val('');
                $('#buscar-dni').val('');
                $('#update-dni').val('');
                $('#update-nombre').val('');
                $('#update-apellidos').val('');
                $('#update-telf').val('');
             }
             else
             {
                 if(flag=1)
                 {
                      $('#add-dni').val(result.dni);
                      $('#add-nombre').val(result.nombres);
                      $('#add-apellidos').val(result.apellidoPaterno+" "+result.apellidoMaterno);
                      boton.removeAttribute('disabled'); 
                 }
                 if(flag=2)
                 {
                     $('#u-dni').val(result.dni);
                     $('#u-nombre').val(result.nombres);
                     $('#u-apellidos').val(result.apellidoPaterno+" "+result.apellidoMaterno);
                     $('#u-telf').val('')
                     botonupdate.removeAttribute('disabled'); 
                 }
             }
             
         }
         })
}
function verificar(id,flag)
{
       if(id.length==8)
           {
            $.ajax({
                type:"GET",
                url:'/Customer/Verificar',
                data:{id:id},
                success:function(result)
                {
                    if(result==true)
                    {
                        Swal.fire({
                            icon: 'error',
                            title: 'Cliente ya registrado',
                            showConfirmButton: false,
                            timer: 1000 })
                            limpiar()
                    }
                     else
                    { addbuscar(id,flag) }
                }
            })
           }
           else
           {
               Swal.fire({
                icon: 'error',
                title: 'El DNI debe tener 8 digitos',
                showConfirmButton: false,
                timer: 900})
           }
} 
$(document).on('keyup','#buscar-dni',function(event)
{
       if (event.keyCode === 13)
       {
           let dni=$('#buscar-dni').val();
           flag=1
           verificar(dni,flag)    
       }
})
$(document).on('click','#buscar-cliente',function()
{
        let dni=$('#buscar-dni').val();
        flag=1
        verificar(dni,flag)  
})
$(document).on('click','#edit-customer',function(){

       var idcustomer=$(this).attr('idcustomer');
       console.log(idcustomer)
       
        $.ajax({
        type:"Post",
        url:"/Customer/Index",
        data:{id:idcustomer},
        success:function(a)
        {
            $('#u-dni').val(a.dnicustomer),
            $('#u-nombre').val(a.namecustomer),
            $('#u-apellidos').val(a.lastnamecustomer),
            $('#u-telf').val(a.phonecustomer)
        }
        })
}) 
$(document).on('click','#update-customer',function()
{        
         var form=$('#update-form').serialize();
         console.log($('#update-form').serializeArray());
         $.ajax({
             type:"POST",
             url:'/Customer/UpdateCustomer',
             data:form,
             success:function(result)
             {
                  $('#editar-c').modal('hide');
                  window.location.reload();
             }
         })
})
$(document).on('click','#update-buscar',function()
{ 
        let dni=$('#update-buscar-dni').val();
        flag=2
        verificar(dni,flag)  
})
$(document).on('click','#borrar-customer',function()
{ 
    var idcustomer=$(this).attr('idcustomer');
   
       //Swal.fire({
       //       title: '¿Desea eliminar?',
       //       icon: 'warning',
       //       showCancelButton: true,
       //       confirmButtonColor: '#3085d6',
       //       cancelButtonColor: '#d33',
       //       confirmButtonText: 'Eliminar'
       //         }).then((result) => {
       //   if (result.isConfirmed) {
       //        $.ajax({
       //             type:'post',
       //             url:'/Customer/DeleteCustomer',
       //             data:{id:idcustomer},
       //             success:function(result)
       //             {
       //                 console.log(result)
                     
       //                     Swal.fire({
       //                     icon: 'success',
       //                     title: 'Cliente Eliminado',
       //                     showConfirmButton: false,
       //                     timer: 2000 })
       //                      window.location.reload();
       //             }
                   
       //             })
       //   }})

       $.ajax({
        type:'post',
        url:'/Customer/Confirmar',
        data:{id:idcustomer},
        success:function(result)
        {
            if(result==false)
            {
                Swal.fire({
                    icon: 'error',
                    title: 'Oops...',
                    text: 'EL CLIENTE TIENE UNA VENTA',
                    showConfirmButton: false,
                    timer: 2000
                   
                })
            }
            else
            {
                 Swal.fire({
                    icon: 'success',
                    title: 'Cliente Eliminado',
                    showConfirmButton: false,
                    })
            }
           setTimeout( ()=>
           {
               window.location.reload()
           },2500);
        }  
       })
   
})


</script>
@section Scripts
{
    @{
        await Html.RenderPartialAsync("_ValidationScriptsPartial");
    }
   
} 

